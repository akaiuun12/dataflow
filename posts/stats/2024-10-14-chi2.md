---
layout: post
category: Stats
tags: ['chi-squared']

date: 2024-10-14
author: Akai Red
title: STATS 101 - chi-squared test 
description: 
    독립변수, 종속변수가 모두 명목형일 때 카이제곱검정을 사용한다.

image: 
    # https://res.cloudinary.com/dhchweuhy/image/upload/c_fill,w_760,h_399,r_5,f_auto,q_auto/lrc/20220301_img1
optimized_image: 
    # https://res.cloudinary.com/dhchweuhy/image/upload/c_fill,w_380,h_200,r_5,f_auto,q_auto/lrc/20220301_img1

show_thumbnail: true
math: true
published: true
---
## 1. Load Dataset
```python
import pandas as pd

df = pd.DataFrame(
    {
        'BloodType': ['O','B','B','O','O','A','AB','A','B','B',
                      'AB','O','B','A','O','A','O','A','A','B'],
        'Sex': ['M','F','F','M','F','F','M','F','F','M',
                'M','M','F','F','M','M','M','F','F','M']    
    }
)
print(df)
```

성별(Sex)과 혈액형(BloodType) 간의 관계를 분석하기 위해서 데이터를 임의로 생성했다. 이 데이터는 카이제곱 검정을 위한 예시로 사용할 것이다.

카이제곱 검정은 두 변수 모두 명목형*Nominal*이어야 한다. 여기서는 성별을 남성(M), 여성(F)으로 구분하고, 혈액형은 A, B, AB, O로 나누었다.

||BloodType|Sex|
|-|-|-|
|1|O|M|
|2|B|F|
|3|B|F|
|...|...|...|
|19|A|F|
|20|B|B|

## 2. Contingency Table
```python
variable1 = 'Sex'
variable2 = 'BloodType'

contingency_table = pd.crosstab(df[variable1], df[variable2])
contingency_table_with_margins = pd.crosstab(df[variable1], df[variable2], margins=True)
print(contingency_table_with_margins)
```

카이제곱 검정을 수행하려면 먼저 두 변수의 분할표*contingency table*를 만들어야 한다. 분할표는 교차표*cross tabulation*라고도 하는데 두 변수 간의 빈도를 요약한 표다.

pd.crosstab() 함수로 두 변수 간의 빈도를 계산하고 분할표 형식으로 출력할 수 있다. `margins=True`를 설정하면 각 행과 열의 합계(주변 확률*marginal probability*)를 같이 표시해준다.

| BloodType |  A  | AB  |  B  |  O  | All |
|-----------|-----|-----|-----|-----|-----|
| F         |  4  |  1  |  4  |  1  |  10 |
| M         |  2  |  2  |  3  |  3  |  10 |
| All       |  6  |  3  |  7  |  4  |  20 |


## 3. Chi-Squared Test
```python
from scipy.stats import chi2_contingency

# 귀무가설: 두 변수는 독립이다.
# 대립가설: 두 변수는 독립이 아니다.

chi2, p, dof, expected = chi2_contingency(contingency_table)
difference = contingency_table - expected

print(f'''
========================================
Chi-Squared Test for Independency
========================================

Chi-Squared: {chi2:.4f}
p-value: {p:.4f}
Degree of Freedom: {dof}

Contingency Table:
observed:
{contingency_table}

expected:
{expected}

difference:
{difference}

chi-squared calculated: {(difference**2 / expected).sum().sum()}
''')
```

이제 카이제곱 검정을 실행해 보자. `scipy.stats`의 `chi2_contingency()` 함수를 사용하면 된다. 결과적으로 p값이 0.0460으로 나왔다. 이는 두 변수 간의 관계가 독립이 아니라는 것을 의미한다. 보다 자세한 이해를 위해 분할표와 기대도수를 바탕으로 직접 카이제곱 통계량을 계산해보자.

```
> ========================================
> Chi-Squared Test for Independency
> ========================================
> 
> Chi-Squared: 8.0000
> p-value: 0.0460
> Degree of Freedom: 3
> 
> Contingency Table:
> observed:
> BloodType  A  AB  B  O
> Sex                   
> F          5   0  4  1
> M          1   2  2  5
> 
> expected:
> [[3. 1. 3. 3.]
>  [3. 1. 3. 3.]]
> 
> difference:
> BloodType    A   AB    B    O
> Sex                          
> F          2.0 -1.0  1.0 -2.0
> M         -2.0  1.0 -1.0  2.0
> 
> chi-squared calculated: 8.0
```

### 카이제곱 통계량

$$
\chi^2 = \sum \frac{(O_i - E_i)^2}{E_i}
$$

- $ O_i $: **관찰도수**(Observed frequency)로 실제 데이터에서 관찰된 빈도.
- $ E_i $: **기대도수**(Expected frequency)로 예상되는 빈도.

위 공식을 사용해서 각 범주의 관찰도수와 기대도수의 차이를 제곱한 뒤 기대도수로 나눈 값을 모두 더하면 $\chi^2$ 통계량을 구할 수 있다. 이 값이 클수록 두 변수 간의 차이가 크다는 의미고 $\chi^2$ 분포에 따라 이 값이 얼마나 유의미한지를 검정하게 된다.

### 예시 데이터의 자유도 계산

자유도(degrees of freedom, $df$)는 카이제곱 검정에서 중요한 요소다. 카이제곱분포는 자유도에 따라 형태가 달라지기 때문이다. 명목형 변수의 경우 자유도는 다음과 같이 계산할 수 있다.

$$
df = (r - 1) \times (c - 1)
$$

- $r$: **행의 범주 수**, $c$: **열의 범주 수**

예시 데이터에서는 혈액형에 4개의 범주(A, B, AB, O), 성별에 2개의 범주(M, F)가 있다. 따라서 자유도는 아래와 같다.

$$
df = (4 - 1) \times (2 - 1) = 3
$$

이렇게 $\chi^2$ 분포의 형태가 결정되며, p-값을 계산할 때 사용한다.


### 직접 계산한 카이제곱 통계량

이제 관찰도수와 기대도수를 사용해 $\chi^2$ 통계량을 계산해보자:

$$
\chi^2 = \frac{(O_1 - E_1)^2}{E_1} + \frac{(O_2 - E_2)^2}{E_2} + \cdots + \frac{(O_n - E_n)^2}{E_n}
$$

각 범주에 대해 계산하면:

- F, A: $\frac{(5 - 3)^2}{3} = \frac{4}{3} \approx 1.333$
- F, AB: $\frac{(0 - 1)^2}{1} = \frac{1}{1} = 1.000$
- F, B: $\frac{(4 - 3)^2}{3} = \frac{1}{3} \approx 0.333$
- F, O: $\frac{(1 - 3)^2}{3} = \frac{4}{3} \approx 1.333$
- M, A: $\frac{(1 - 3)^2}{3} = \frac{4}{3} \approx 1.333$
- M, AB: $\frac{(2 - 1)^2}{1} = \frac{1}{1} = 1.000$
- M, B: $\frac{(2 - 3)^2}{3} = \frac{1}{3} \approx 0.333$
- M, O: $\frac{(5 - 3)^2}{3} = \frac{4}{3} \approx 1.333$

이 값들을 모두 더하면:

$$
\chi^2 = 1.333 + 1.000 + \cdots + 1.333 = 8.000
$$

이렇게 계산된 통계량은 $\chi^2$ 분포를 따르며 이를 바탕으로 p-값을 통해 두 변수 간의 독립성을 검정할 수 있다. 직접 계산한 값과 `chi2_contingency()` 함수로 계산한 값이 일치함을 확인할 수 있다.


## 4. Chi-Squared Distribution
```python
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats

chi2_dist = stats.chi2(df=dof)

x_range = np.linspace(0, 20, 100)

plt.plot(x_range, chi2_dist.pdf(x_range), 
         label=f'자유도 {dof}인 카이제곱분포')
plt.vlines(x=chi2, 
           ymin=0, ymax=max(chi2_dist.pdf(x_range)),
           linestyles='--', label=f'카이제곱통계량: {chi2:.2f}')
plt.fill_between(np.linspace(chi2, 20, 100), 
                 chi2_dist.pdf(np.linspace(chi2, 20, 100)),
                 label=f'색칠한 부분의 넓이: {1-chi2_dist.cdf(chi2):.3f}')
plt.legend()
plt.show()
```

카이제곱 통계량이 얼마나 극단적인지 시각적으로 확인하려면 카이제곱 분포를 그려보면 된다. 이를 통해 통계량이 어느 위치에 있는지 알 수 있다.

![picture 0](/imgs/09b80d148746eadc7acac108f39a90e1800aed93c26b1338585f71f2cbddd75e.png)  

위 코드는 카이제곱 분포와 검정통계량을 함께 시각화한 그래프다. 검정통계량을 초과하는 확률밀도의 합이 0.046이다. 이 값이 바로 p값의 정체이다.

## 5. Independence Test & Homogeneity Test
카이제곱 검정은 독립성 검정과 동질성 검정 두 가지로 나뉜다. 독립성 검정은 두 변수 간의 관계를, 동질성 검정은 여러 집단 간의 분포가 동일한지를 검정한다. 두 검정의 차이점은 **연구 질문**의 차이에 있다.

- **독립성 검정**은 성별과 혈액형 간의 관계, 즉 두 변수가 독립적인지를 검증한다.
- **동질성 검정**은 성별이라는 그룹에서 혈액형 분포가 동일한지를 확인한다.

하지만 이 둘은 수학적으로 보면 **완전히 동일한 계산 과정**을 따른다. 결국 둘 다 **범주형 변수의 분할표**를 기반으로 기대값과 관찰값의 차이를 검토하는 카이제곱 통계량을 계산한다. 실제로 귀무가설도 매우 유사한 구조를 가지고 있다. 

연구 질문에 따라 둘을 구분하지만 그 근본적인 통계적 원리는 동일하다. 두 검정을 구분해서 이해하는 것도 중요하지만 이들이 **동일한 통계 원리**를 따른다는 점을 기억하면 더 쉽게 접근할 수 있을 것이다.

## References
* [Wikipedia: Chi-Squared Test](https://en.wikipedia.org/wiki/Chi-squared_test)