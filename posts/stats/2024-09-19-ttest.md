---
layout: post
category: Stats
tags: ['t-test']

date: 2024-09-19
author: Akai Red
title: STATS 101 - t-test 
description: 
    집단의 평균을 비교하기 위해 t 검정을 사용한다.

image: 
    # https://res.cloudinary.com/dhchweuhy/image/upload/c_fill,w_760,h_399,r_5,f_auto,q_auto/lrc/20220301_img1
optimized_image: 
    # https://res.cloudinary.com/dhchweuhy/image/upload/c_fill,w_380,h_200,r_5,f_auto,q_auto/lrc/20220301_img1

show_thumbnail: true
math: true
published: true
---

## 0. Prerequisites
```python
# !conda install numpy
# !conda install pandas
import numpy as np
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

import scipy.stats as stats
import statsmodels.api as sm

df = sm.datasets.get_rdataset("cats","MASS").data
dv = 'Bwt'
```
위 코드는 R MASS 패키지에서 제공하는 고양이 144마리의 몸무게 데이터를 불러온다. 해당 데이터를 사용하여 t검정을 확인해보자.

## Normality Test
```python
# 정규성 검증: Shapiro-Wilks test
# Shapiro-Wilks test가 p-value < 0.05로 기각된다면
# 데이터가 정규분포를 따르지 않는다는 뜻이다.
_, p_value = stats.shapiro(df[dv])

if p_value > 0.05:
    # 데이터가 정규성을 띄면 one-sample t-test 진행 
    print(f'''
    Shapiro Test Result: {p_value:.2f} > 0.05
    Normality assumption satisfied. Try t-test!
    ''')
else:
    # 데이터가 정규성을 안 띄면 Wilcoxon test 진행
    print(f'''
    Shapiro Test Result: {p_value:.2f} < 0.05
    Normality assumption unsatisfied. Try Wilcoxon test!
    ''')
    print(stats.wilcoxon(df[dv]-mu, alternative='two-sided'))
```
t검정을 시행하기 위해서는 데이터가 **1.독립성 가정, 2.정규성 가정**을 만족해야 한다. 독립성은 일반적으로 데이터 수집 단계에서 보장되는지 확인한다. 

정규성은 중심극한정리*Central Limit Theorem; CLT*를 사용하거나 K-S검정, Shapiro 검정 등을 사용해 확인한다.

본 데이터는 30건 이상으로 중심극한정리에 따라 t검정을 수행하는데 문제가 없다. 만약 데이터 크기가 작고, 정규성 검정 후 정규분포를 따르지 않을 경우 비모수 검정을 사용한다. 

## 1. One-sample t-test
```python
t, p_value, dof = stats.ttest_1samp(df[dv], popmean=mu)
```
**단일표본 t검정***one-sample t-test*은 특정 집단의 평균*population mean*이 특정 값과 동일한지 통계적으로 확인한다. 데이터를 DataFrame 형식으로 불러오기만 한다면 아래 템플릿은 일반적으로 사용할 수 있다. 

### 1-1. Data Visualization
```python
sns.histplot(df[dv], bins=15)
plt.vlines(x=df[dv].mean(), ymin=0, ymax=20, 
           color='g', linestyle='--', label='mean')
plt.vlines(x=mu, ymin=0, ymax=20, 
           color='r', linestyle='--', label='hypothesis')
plt.ylim(0,20)
plt.tight_layout()
plt.legend()
plt.show()
```
![picture 2](/imgs/2024-09-19-ttest-diagram-01.png)  

데이터 분포는 오른쪽으로 치우친*right-skewed* 분포이다. 몸무게의 평균은 약 2.7인데 이 평균값이 2.6과 통계적으로 유의미한 차이가 존재하는지 확인해보자.

### 1-2. Statistical Test
```python
t, p_value, dof = stats.ttest_1samp(df[dv], popmean=mu)

print(f'''
df 데이터는 총 {df.shape[0]}개의 데이터로 구성되어 있다.
{dv} 데이터 평균은 {df[dv].mean():.2f}이며 
one-sample t-test 결과 p-value = {p_value:.2f}으로 통계적으로 유의미하다.
''')
```

분석 결과 p < .05이므로 유의수준 .05 하에서 고양이의 평균 몸무게는 2.6과 다르다고 할 수 있다.

※ `dof`(자유도)는 `scipy=1.10.0` 버전부터 적용된다.

## 2. Paired-sample t-test
```python
t, p_value, dof = stats.ttest_rel(df['after'], df['before'], alternative='greater')
```
```python
data = {'before':[7,3,4,5,2,1,6,6,5,4],
        'after':[8,4,5,6,2,3,6,8,6,5]}

df = pd.DataFrame(data)
dv = 'diff'
df[dv] = df['after'] - df['before']

# 2-1. Visualization
sns.histplot(df[dv], bins=15)
plt.vlines(x=df[dv].mean(), ymin=0, ymax=7.5, 
           color='g', linestyle='--', label='mean')
plt.vlines(x=0, ymin=0, ymax=7.5, 
           color='r', linestyle='--', label='hypothesis')
plt.ylim(0,7.5)
plt.tight_layout()
plt.legend()
plt.show()

# 2-2. Statistical Test
# 정규성 검증: Shapiro-Wilks test
_, p_value = stats.shapiro(df[dv])

if p_value > 0.05:
    # 데이터가 정규성을 띄면 one-sample t-test 진행 
    print(f'''
    Shapiro Test Result: {p_value:.2f} > 0.05
    Normality assumption satisfied. Try t-test!
    ''')
    print(stats.ttest_rel(df['after'], df['before'], alternative='greater'))
else:
    # 데이터가 정규성을 안 띄면 Wilcoxon test 진행
    print(f'''
    Shapiro Test Result: {p_value:.2f} < 0.05
    Normality assumption unsatisfied. Try Wilcoxon test!
    ''')
    print(stats.wilcoxon(df['after'], df['before'], alternative='two-sided'))
```
![picture 3](/imgs/2024-09-19-ttest-diagram-04.png)  

동일 집단 내 처치 전후의 차이를 확인하기 위해서는 **대응표본 t검정***paired-sample t-test*를 사용한다. 귀무가설은 처치 전후의 차이가 없음이고, 대립가설을 채택할 경우 처치 전후 통계적으로 유의미한 차이가 있음을 의미한다.

대응표본 t검정의 경우에도 정규성 가정을 만족하여야 하며, 위 데이터의 경우 정규성을 만족하지 않아 Wilcoxon Test를 수행하였다.

## 3. Independent-sample t-test
```python
# Welch's t-test
t, p_value, dof = stats.ttest_ind(group_A[dv], group_B[dv], equal_var=False) 
```
```python
df = sm.datasets.get_rdataset("cats","MASS").data
dv = 'Bwt'
iv = 'Sex'
conditions = {'A':'M', 'B':'F'}

group_A = df[df[iv] == conditions['A']]
group_B = df[df[iv] == conditions['B']]

# 3-1. Visualization
fig, axes = plt.subplots(nrows=2, ncols=1)

sns.histplot(group_A[dv], bins=15, ax=axes[0])
sns.histplot(group_B[dv], bins=15, ax=axes[1])
plt.tight_layout
plt.show()

# 3-2. Statistical Test
print(stats.ttest_ind(group_A[dv], group_B[dv], 
                      equal_var=False))  # Welch's t-test

print(f'Group A Mean: {group_A[dv].mean()}')
print(f'Group B Mean: {group_B[dv].mean()}')
```
서로 다른 두 집단의 평균을 비교하기 위해 **독립표본 t검정***independent-sample t-test*를 사용한다. 일반적으로는 t검정 시 앞서 말한 1.독립성, 2.정규성 외 세번째 가정으로 3.등분산성 가정을 추가한다.

**그러나** 독립표본 t검정을 시행할 때 항상 [Welch's t-test](https://en.wikipedia.org/wiki/Welch%27s_t-test)를 수행하면 되며, 등분산성 확인을 위해 Levene test 등을 수행할 필요는 없다. 

오히려 등분산성을 미리 확인하고 Student's t-test와 Welch's t-test를 고르는 것을 경계해야 한다. **단, 정규성 조건은 여전히 유효하다.**

![picture 4](/imgs/2024-09-19-ttest-diagram-03.png)  


## 4. Confidence Interval
```python
ci = stats.ttest_ind(group_A[dv], group_B[dv], equal_var=False
                    ).confidence_interval(confidence_level=0.95)

print(f'Confidence Interval: [{ci[0]:.2f}, {ci[1]:.2f}]')
```
`.confidence_interval()` 메서드는 t검정 결과의 신뢰구간을 구할 수 있는 메서드로 `scipy=1.10.0` 버전부터 추가되었다. `confidence_level=0.95`로 신뢰구간의 범위를 지정할 수 있으며 결과로 신뢰구간의 하한, 상한을 튜플 형태로 반환한다.

## References
* [Welch's t-test](https://en.wikipedia.org/wiki/Welch%27s_t-test)