---
layout: post
category: Python
tags: ['data structure']

date: 2024-09-10
author: Akai Red
title: Python 날짜 데이터 처리
description: 
    날짜 데이터 처리를 위한 datetime, numpy, pandas 패키지를 비교한다.

image: 
    https://res.cloudinary.com/dhchweuhy/image/upload/c_fill,w_760,h_399,r_5,f_auto,q_auto/lrc/20220301_img1
optimized_image: 
    # https://res.cloudinary.com/dhchweuhy/image/upload/c_fill,w_380,h_200,r_5,f_auto,q_auto/lrc/20220301_img1

show_thumbnail: true
math: true
published: true
---

데이터 분석 시 가장 처리하기 곤란한 데이터가 날짜 및 시간 데이터다. 윤년, 윤초 등 예외도 많고 일반적인 숫자 연산과는 다른 규칙을 적용해야 한다. 그렇기 때문에 날짜 처리하는 전용 패키지 및 자료형이 존재한다. 이 글에서는 `datetime`, `numpy`, `pandas` 패키지에서 제공하는 날짜 자료형 및 전용 함수를 소개하고 비교해본다.

| Library   | Class                 | timedelta Class   | relativedelta Class | 
|-|-|-|-|
| datetime  | datetime, time, date  | timedelta         | relativedelta       |
| numpy     | datetime64            | timedelta64       | -                   |
| pandas    | Timestamp             | Timedelta         | DateOffset          |

## Datetime Basics
### datetime: datetime
```python
# datetime: datetime
from datetime import datetime
from dateutil.relativedelta import relativedelta

today = datetime.now()                          # 현재 시각
tomorrow = today + relativedelta(days=1)        # 현재 시각으로부터 1일 후
yesterday = today - relativedelta(days=1)       # 음수 연산 지원

next_month = today + relativedelta(months=1)    # 현재 시각으로부터 1개월 후
last_year = today - relativedelta(years=1)      # 현재 시각으로부터 1년 전
```
`datetime`은 Python 내장 모듈로 별도 패키지 설치 없이 사용할 수 있다. `datetime.now()`를 사용해서 현재 시각을 `datetime` 형식으로 확인하고 `relativedelta` 자료형을 사용해 날짜를 더하고 뺄 수 있다.

### numpy: datetime64
```python
# numpy: datetime64
import numpy as np

today = np.datetime64('now')                    # 현재 시각
today_date = np.datetime64('today')             # 현재 날짜

tomorrow = today + np.timedelta64(1, 'D')       # 현재 시각으로부터 1일 후
yesterday = today - np.timedelta64(1, 'D')      # 음수 연산 지원

# next_month = today + np.timedelta64(1, 'M')   # 월 연산 지원 X
# last_year = today - np.timedelta64(1, 'Y')    # 연 연산 지원 X
```
`numpy`에서는 `datetime64` 자료형을 사용해서 날짜/시간을 표현한다. 

`np.datetime64('now')` 혹은 `np.datetime64('today')`를 사용하면 현재 시각을 확인할 수 있다. `'now'`는 현재 시각을 초 단위로, `'today'`는 일*day* 단위로 반환한다. 만약 밀리초*ms* 단위로 현재 시각을 확인하고 싶다면 `datetime` 자료형을 `datetime64` 자료형으로 변환하여 사용하자.

날짜/시각의 차를 구하기 위해서 `timedelta64`를 사용한다. 하루는 `np.timedelta64(1, 'D')`, 한주는 `np.timedelta64(1, 'W')`로 표현하여 연산한다. 

중요한 것은 한달, 일년은 `timedelta64`를 사용해서 연산할 수 없다는 것이다. [관련 Stackoverflow 답변](https://stackoverflow.com/a/31407880)에 따르면 연도와 월은 시간으로 정확히 환산할 수 없기 때문이라고 하는데.. `datetime`, `pandas` 및 SQL 등에서는 간단하게 지원하는 기능이라 아쉽다.

### pandas: Timestamp
```python
# pandas: Timestamp
import pandas as pd

today = pd.Timestamp('now')                     # 현재 시각

tomorrow = today + pd.DateOffset(days=1)        # 현재 시각으로부터 1일 후
yesterday = today - pd.DateOffset(days=1)       # 음수 연산 지원

next_month = today + pd.DateOffset(months=1)    # 현재 시각으로부터 1개월 후
last_year = today - pd.DateOffset(years=1)      # 현재 시각으로부터 1년 전
```
`pandas`는 `Timestamp` 자료형과 `DateOffset`을 사용해서 날짜 연산을 수행한다. 기본적으로 `datetime` 패키지와 동일한 방법으로 사용할 수 있다.  


## Datetime Advanced
### String to Datetime
```python
time_dt = datetime(2024, 8, 31)         # (2024, 8, 31)
time_np = np.datetime64('2024-08-31')   # ('2024-08-31')
time_pd = pd.Timestamp('2024-8-31')     # (2024, 8, 31), ('2024-8-31'), ('2024-08-31'), ('2024/8/31'), ('2024/08/31')

# DataFrame
pd.to_datetime(df['date_string'], format'%Y%m%d') 
```
문자열*string*을 날짜*datetime* 형식으로 바꿀 때 `datetime`, `numpy`, `pandas`는 차이가 있다. 

`datetime`이나 `numpy`는 정해진 형식만을 지원한다. 예를 들어 `datetime`은 문자열 입력을 직접 지원하지 않고 `datetime.fromisoformat` 등의 별도 메서드를 사용해야 한다. `numpy`의 경우 '2024-08-31'는 가능하지만, '2024/08/31'나 '2024-8-31'는 불가능하다.

반면 `pandas Timestamp`는 (2024, 8, 31), ('2024-8-31'), ('2024-08-31'), ('2024/8/31'), ('2024/08/31') 등 다양한 입력 형식을 지원한다.

※ `pd.to_datetime()` 함수로 문자열 컬럼을 `datetime64[ns]` 형식으로 변환할 수 있다.

### Datetime to String
```python
# datetime, pandas
today_dt = datetime.now()
# today_pd = pd.Timestamp('now')도 동일하다.

## Date (in string)
today_dt.strftime('%Y%m%d') # '20240806'    
today_dt.strftime('%y')     # '24'

## Dayname (in string)
today_dt.weekday()          # 0
today_dt.strftime('%a')     # 'Mon'
today_dt.strftime('%A')     # 'Monday'

## Month (in string)
today_dt.strftime('%b')     # 'Aug'  
today_dt.strftime('%B')     # 'August'               
today_dt.strftime('%m')     # '08'    

## Hour (in string)
today_dt.strftime('%H')     # 15       

# numpy
today_np = np.datetime64('now')
np.datetime_as_string(today_np, unit='D')   # '2024-08-06'  
```
날짜*datetime*를 문자열*string* 형식으로 바꾸기 위해서는 `strftime` 함수를 사용한다. 

특정 날짜의 요일이 궁금할 때는 `strftime`를 사용하거나 `.weekday()` 메서드를 사용하자. `.weekday()` 메서드는 `datetime`과 `pandas`에서 모두 사용가능하며 주어진 날짜의 요일을 정수 형태로 반환한다. `pandas`는 아예 요일을 문자열 형태로 반환하는 `.day_name()`이라는 메서드도 존재한다. 

`numpy`에서는 `np.datetime_as_string()` 함수를 통해 문자열 변환을 일부 지원한다. 그러나 `unit` 파라미터를 통해 표시할 날짜 단위를 선택할 수 있을 뿐 자유로운 날짜 포맷팅은 불가능하다.

### First Day, Last Day of Month
```python
# datetime
today_dt = datetime.now()                           # 2012-09-10 16:52:32.600868
first_day_dt = today_dt - relativedelta(day=1)      # 2012-09-01 16:52:32.600868
last_day_dt = today_dt + relativedelta(day=31)      # 2012-09-30 16:52:32.600868

wrong_answer = today_dt + relativedelta(days=31)    # 2012-10-11 16:52:32.600868

# pandas
today_pd = pd.Timestamp('now')                      # 2012-09-15 16:52:32.600868
first_day_pd = today_pd - pd.DateOffset(day=1)      # 2012-09-01 16:52:32.600868
last_day_pd = today_pd + pd.DateOffset(day=31)      # 2012-09-30 16:52:32.600868

first_day_pd = today_pd - pd.offsets.MonthBegin()   # 2012-09-01 16:52:32.600868
last_day_pd = today_pd + pd.offsets.MonthEnd()      # 2012-09-30 16:52:32.600868
```

특정 날짜가 속한 달의 첫째날, 마지막날을 구하는 경우가 종종 생긴다. 함수 하나로 간단하게 해결할 수 있으면 좋을텐데 그런 방법은 찾지 못했다. 대신 `relativedelta`나 `DateOffset`을 사용한 날짜 연산으로 구할 수 있다.

여기서 중요한 점은 `day` 파라미터와 `days` 파라미터의 역할은 다르다는 것. 간단하게 말하면 `day` 파라미터는 특정 날짜로 변환*replace*해주고 `days` 파라미터는 일반적으로 생각하는 날짜 연산을 지원한다. 자세한 내용은 [공식 문서](https://dateutil.readthedocs.io/en/stable/relativedelta.html)을 확인해보자. 위 코드의 `last_day_dt`변수와 `wrong_answer` 변수가 `day` 파라미터와 `days` 파라미터의 차이점을 보여준다. 

`pandas`에서도 `relativedelta`와 동일한 역할을 하는 `DateOffset`을 활용해 달의 첫째날, 마지막날을 구할 수 있다. `pandas`는 아예 `pd.offsets.MonthBegin()`라는 별도의 메서드를 지원하는데, 사용법은 `DateOffset`과 동일하다.


## References
* [strftime() and strptime() Format Codes](https://docs.python.org/3.8/library/datetime.html#strftime-and-strptime-format-codes)
* [python, numpy, pandas 날짜 타입 비교 및 정리](https://ellun.tistory.com/320)
* [numpy and pandas timedelta error](https://stackoverflow.com/a/31407880)
* [relativedelta — dateutil 3.9.0 documentation - Read the Docs](https://dateutil.readthedocs.io/en/stable/relativedelta.html)
