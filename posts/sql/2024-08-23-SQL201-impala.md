---
layout: post
category: SQL
tags: ['sql']

date: 2024-08-23
author: Akai Red
title: SQL201 - Impala 기초 및 날짜 데이터 처리
description: 
    Impala에서 날짜를 다루는 방법만 익숙해지면 나머지는 Oracle SQL과 유사하다.

image: 
    # https://res.cloudinary.com/dhchweuhy/image/upload/c_fill,w_760,h_399,r_5,f_auto,q_auto/lrc/20220301_img1
optimized_image: 
    # https://res.cloudinary.com/dhchweuhy/image/upload/c_fill,w_380,h_200,r_5,f_auto,q_auto/lrc/20220301_img1

show_thumbnail: true
math: true
published: true
---
## Hadoop
Hadoop은 대규모 데이터를 처리하기 위한 오픈소스 프레임워크로 분산 저장과 병렬 처리를 지원한다. Hadoop의 주요 구성 요소 중 하나인 HDFS(Hadoop Distributed File System)는 데이터를 여러 노드에 분산 저장한다.

## Impala
Impala는 Cloudera에서 개발한 대화형 SQL 쿼리 엔진으로, Hadoop의 분산 저장 시스템인 HDFS 위에서 직접 SQL 쿼리를 실행할 수 있다. 이러한 기술을 SQL on Hadoop이라고 부르며 Impala 외에 Hive, Presto, Spark SQL 등 다양한 기술이 존재한다. 

복잡한 기술적 얘기는 잠시 내려놓고, Impala는 Hadoop 및 HDFS를 사용해 저장된 데이터를 불러오는데 사용한다. 고전적인 DB 환경에서 Oracle SQL을 써서 데이터를 불러왔듯이 말이다. Impala는 경쟁자인 Hive보다 이해하기 쉬운 SQL 형식을 사용하고 있으며 빠르다.

### DDL
```sql
CREATE TABLE IF NOT EXISTS 테이블명 AS
SELECT ... 
  FROM ...
;
```
오라클은 테이블 존재여부에 따라 테이블 생성 여부를 결정할 수 없었다. 일일이 돌려보고(..) 하나씩 지워가며 테이블을 만들었다. HUE 환경에서 Impala를 사용하면 테이블이 존재하지 않을 경우만 새 테이블을 생성하도록 할 수 있다.

### Datetime Basics
```sql
SELECT                                      
      -- SYSDATE              -- in Oracle..
       now()
     , current_timestamp()    -- now()와 같다            

      -- SYSDATE-3
     , date_add(now(), 3)     -- 현재 시각으로부터 3일 후
     , date_sub(now(), 3)     -- 현재 시각으로부터 3일 전
     , date_add(now(), -3)    -- 음수 연산도 지원
      
      -- ADD_MONTHS(SYSDATE, 12), 
     , months_add(now(), 12) -- 현재 시각으로부터 12개월 후
     , years_add(now(), 12)  -- 현재 시각으로부터 12년 후
;                            -- FROM DUAL;
```

Impala에서 날짜를 다루는 방법만 익숙해지면 나머지는 일반적인 SQL과 유사하다. Oracle에 익숙한 사람은 큰 노력을 들이지 않고 Impala를 사용할 수 있다. 나도 Oracle을 주로 써왔지만 부서를 옮기면서 Impala를 접했고 금방 익숙해졌다.

현재 시각을 구하려면 `now()` 혹은 `current_timestamp()` 함수를 사용한다. [Impala 공식 문서](https://impala.apache.org/docs/build/html/topics/impala_datetime_functions.html#datetime_functions__current_timestamp)에 따르면 `now()`와 `current_timestamp()` 함수는 동일하다.

Oracle에서는 날짜*datetime*에 바로 날짜를 더하거나 뺄 수 있었지만 Impala에서는 불가능하다. 대신 `date_add`, `date_sub` 함수를 사용한다. 음수 연산도 지원하니 `date_add`만으로 충분하다. 달을 더할 때는 `months_add`, 해를 더할 때는 `years_add`를 사용하면 된다. 

(Oracle의 경우 해를 더할 때 `add_months`를 사용해서 개월 수로 환산해서 더한다. INTERVAL을 사용하는 방법도 있지만 윤달, 윤년 처리 시 문제가 발생할 수 있다고 하니 주의하자.)


### String to Datetime, Datetime to String
```sql
SELECT 
      -- TO_DATE('2012-03-15 16:52:32', 'YYYY-MM-DD HH24:MI:SS')  -- case insensitive
     , to_timestamp('2012-03-15 16:52:32', 'yyyy-MM-dd HH:mm:ss') -- *case sensitive

      -- TO_CHAR(SYSDATE, 'YYYYMM')
     , from_timestamp(now(), 'yyyyMM')                            -- *case sensitive

      -- TO_CHAR(SYSDATE, 'Day')
     , dayname(now())               -- Thursday
     , from_timestamp(now(), 'dd')  -- 17

      -- TO_CHAR(SYSDATE, 'Month')
     , monthname(now())             -- August
     , from_timestamp(now(), 'MM')  -- 08
     , from_timestamp(now(), 'MMM') -- Aug

      -- TO_CHAR(SYSDATE, 'HH')
     , hour(now())                  -- 17
     , from_timestamp(now(), 'HH')  -- 17
;
```

문자열*string*을 날짜*datetime* 형식으로 바꾸기 위해서는 `to_timestamp` 함수를 사용한다. 주의할 점은 Oracle과 달리 Impala는 대소문자를 구분한다는 것이다. 월은 `MM`, 분은 `mm`으로 구분해서 써줘야 한다.

날짜를 문자열로 바꿀 때는 `from_timestamp` 함수를 사용한다. Oracle과는 달리 요일명 혹은 월 이름을 구하기 위해서는 `dayname`이나 `monthname` 등의 함수를 추가적으로 사용해줘야 한다. 그 외에는 ANSI 표준 형태인 `yyyyMMdd HH:mm:ss.SSS`를 사용하면 된다.


### First Day, Last Day of Month
```sql
SELECT now()                        -- '2012-03-15 16:52:32'
       date_trunc('MONTH', now())   -- '2012-03-01 00:00:00'
       last_day(now())              -- '2012-03-31 00:00:00'
;
```

`last_day(TIMESTAMP)` 함수는 특정 날짜*Timestamp*가 주어졌을때 해당 월의 마지막 날을 반환한다. 예를 들어 3월 15일을 입력으로 넣으면, 3월 31일을 출력으로 반환하는 함수다. 

`first_day()`라는 함수는 없는데 대신 `date_trunc('MONTH', TIMESTAMP)`를 사용하면 동일한 결과를 얻을 수 있다. `date_trunc()`는 특정 기준으로 주어진 날짜를 자르는*truncate* 함수이며 이를 활용하면 특정 월의 첫째날 뿐만 아니라 특정 연도의 첫째날도 구할 수 있다.


## HUE Editor
![picture 0](/imgs/2024-08-23-impala-diagram-01.png)  

HUE(*Hadoop User Experience*)는 하둡 에코시스템에 속하는 웹 기반 사용자 인터페이스다. 나는 업무에서 주로 Impala 쿼리를 HUE 환경에서 실행하고 사용한다.

### Shortcuts
| 기능*functions* | 단축키*shortcuts* |
|-|-|
| 설정 패널 열기 | Ctrl + , |
| 대문자화 | Ctrl + U |
| 소문자화 | Ctrl + Shift +U |
| 주석 처리 | Ctrl + / |
| 탭 들여쓰기 | Ctrl + ] 혹은 Tab |
| 탭 내어쓰기 | Ctrl + [ 혹은 Shift + Tab |

HUE에서 유용하게 사용하는 단축키를 소개한다. 주석 및 탭은 다른 에디터에서도 자주 사용하는 키 바인딩이다. 그 외 폰트 크기 변경, 다크모드 등은 설정 패널에서 적용할 수 있다.

### Bind Variable
```sql
SELECT ${today='20240401'};
-- SELECT ${today = '20240401'};    -- 띄어쓰기 사용 불가
-- SELECT ${today=NOW()};           -- 함수 사용 불가
-- SELECT ${today = '2024 04 01'};  -- 문자열 내 띄어쓰기는 사용 가능
```

`${}`를 사용하면 HUE 환경에서 Impala도 바인드 변수를 사용할 수 있다. 다만 `{}` 내 띄어쓰기나 함수를 지원하지 않는다. `=variable` 부분은 디폴트 값이며 지정하지 않아도 된다.

## References
* [Impala 공식 문서](https://impala.apache.org/docs/build/html/topics/impala_datetime_functions.html#datetime_functions__current_timestamp)
* [SQL On Hadoop 분석 도구인 Hive와 Impala는 어떤 차이가 있을까?](https://www.2e.co.kr/news/articleView.html?idxno=301587)
* [Hue - The open source SQL Assistant for Data Warehouses](https://gethue.com/)
